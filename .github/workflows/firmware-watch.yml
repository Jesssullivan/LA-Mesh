name: Firmware Watch

on:
  schedule:
    # Check daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-meshtastic:
    name: Check Meshtastic Releases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get pinned version
        id: pinned
        run: |
          VERSION=$(jq -r '.meshtastic.version' firmware/manifest.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Get latest release
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(gh api repos/meshtastic/firmware/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST" >> "$GITHUB_OUTPUT"

          NOTES=$(gh api repos/meshtastic/firmware/releases/latest --jq '.body' | head -50)
          # Write notes to file to avoid shell escaping issues
          echo "$NOTES" > /tmp/release-notes.txt

      - name: Compare versions
        if: steps.pinned.outputs.version != steps.latest.outputs.version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PINNED: ${{ steps.pinned.outputs.version }}
          LATEST: ${{ steps.latest.outputs.version }}
        run: |
          echo "Update available: v$PINNED -> v$LATEST"

          # Check if issue already exists
          EXISTING=$(gh issue list --search "Firmware update: v$LATEST" --json number --jq '.[].number' || true)
          if [ -n "$EXISTING" ]; then
            echo "Issue #$EXISTING already exists, skipping."
            exit 0
          fi

          # Create issue
          NOTES=$(cat /tmp/release-notes.txt)
          gh issue create \
            --title "Firmware update: v$PINNED -> v$LATEST" \
            --label "firmware,upstream" \
            --body "$(cat <<EOF
          ## Meshtastic Firmware Update Available

          | | Version |
          |---|---------|
          | **Current (pinned)** | v$PINNED |
          | **Latest upstream** | v$LATEST |

          ### Release Notes (excerpt)

          $NOTES

          ### Links

          - [Release page](https://github.com/meshtastic/firmware/releases/tag/v$LATEST)
          - [Full changelog](https://github.com/meshtastic/firmware/compare/v$PINNED...v$LATEST)

          ### Action Items

          - [ ] Review release notes for breaking changes
          - [ ] Check for security advisories / CVEs
          - [ ] Download and test on evaluation device
          - [ ] Update \`firmware/manifest.json\` version and SHA256 hashes
          - [ ] Update \`firmware/meshtastic/update-checklist.md\` if needed
          - [ ] Flash infrastructure nodes (routers, gateway)
          - [ ] Flash client devices at next meetup

          ### Commands

          \`\`\`bash
          # Download new firmware
          just fetch-firmware --version $LATEST

          # Update manifest hashes
          just firmware-update-hashes

          # Check a device
          just provision station-g2 /dev/ttyUSB0
          \`\`\`
          EOF
          )"

      - name: Up to date
        if: steps.pinned.outputs.version == steps.latest.outputs.version
        run: echo "Firmware is up to date (v${{ steps.pinned.outputs.version }})"
